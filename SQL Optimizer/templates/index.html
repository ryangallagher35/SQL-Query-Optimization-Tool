<!DOCTYPE html>
<html>
<head>
    <title>SQL Query Optimizer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>SQL Query Optimizer</h1>
        <label for="dbPath">Database Path:</label><br>
        <input id="dbPath" type="text" placeholder="e.g., \path\to\your.db"><br><br>

        <label for="query">SQL Query:</label><br>
        <textarea id="query" rows="10" cols="80" placeholder="Enter your SQL query here..."></textarea><br><br>

        <button onclick="analyzeQuery()">Analyze</button>
        <div id="results"></div>
    </div>

    <script>
        async function analyzeQuery() {
            const dbPath = document.getElementById("dbPath").value;
            const query = document.getElementById("query").value;

            const response = await fetch("/analyze", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ db_path: dbPath, query: query })
            });

            const resultDiv = document.getElementById("results");
            resultDiv.innerHTML = ""; 

            const result = await response.json();

            if (result.error) {
                resultDiv.innerHTML = `<p style="color:red;">Error: ${result.error}</p>`;
                return;
            }

            resultDiv.innerHTML += `<h2>Query Summary</h2>`;

            const summary = result.query_summary;
            if (summary && Object.keys(summary).length > 0) {
                const table = document.createElement("table");
                table.classList.add("results-table");

                const tbody = document.createElement("tbody");

                Object.entries(summary).forEach(([key, value]) => {
                    const tr = document.createElement("tr");

                    const tdKey = document.createElement("td");
                    tdKey.textContent = key;
                    tdKey.style.fontWeight = "bold";
                    tdKey.style.paddingRight = "10px";

                    const tdValue = document.createElement("td");
                    
                    // Check if value is an array of objects (subquery-like)
                    if (Array.isArray(value) && value.length > 0 && typeof value[0] === "object" && key === "Subqueries") {
                        const containerDiv = document.createElement("div");

                        value.forEach((subqueryData, index) => {
                            const subqueryTitle = document.createElement("h3");
                            subqueryTitle.textContent = `Subquery ${index + 1}`;
                            containerDiv.appendChild(subqueryTitle);

                            const subqueryTable = document.createElement("table");
                            subqueryTable.classList.add("results-table");

                            const subqueryThead = document.createElement("thead");
                            const headerRow = document.createElement("tr");

                            const columns = Object.keys(subqueryData);
                            columns.forEach(col => {
                                const th = document.createElement("th");
                                th.textContent = col;
                                headerRow.appendChild(th);
                            });
                            subqueryThead.appendChild(headerRow);
                            subqueryTable.appendChild(subqueryThead);

                            const subqueryTbody = document.createElement("tbody");
                            const trSub = document.createElement("tr");
                            columns.forEach(col => {
                                const td = document.createElement("td");
                                td.textContent = subqueryData[col];
                                trSub.appendChild(td);
                            });
                            subqueryTbody.appendChild(trSub);
                            subqueryTable.appendChild(subqueryTbody);

                            containerDiv.appendChild(subqueryTable);
                        });

                        tdValue.appendChild(containerDiv);
                    } else {
                        tdValue.textContent = Array.isArray(value) ? value.join(", ") : value;
                    }

                    tr.appendChild(tdKey);
                    tr.appendChild(tdValue);
                    tbody.appendChild(tr);
                });

                table.appendChild(tbody);
                resultDiv.appendChild(table);
            } else {
                resultDiv.innerHTML += "<p>No summary available.</p>";
            }

            resultDiv.innerHTML += `<h2>Warnings</h2>`;
            if (result.issues.length > 0) {
                result.issues.forEach(i => {
                    resultDiv.innerHTML += `<p><b>${i.type}</b>: ${i.message}</p>`;
                });
            } else {
                resultDiv.innerHTML += "<p>No major issues detected.</p>";
            }

            resultDiv.innerHTML += `<h2>Suggestions</h2>`;
            result.suggestions.forEach(s => {
                resultDiv.innerHTML += `<p>- ${s}</p>`;
            });

            resultDiv.innerHTML += `<h2>Explain Plan</h2>`;

            if (result.explain_plan.length > 0) {
                const table = document.createElement("table");
                table.classList.add("results-table");

                const columnNames = Object.keys(result.explain_plan[0]);

                const thead = document.createElement("thead");
                const headerRow = document.createElement("tr");
                columnNames.forEach(col => {
                    const th = document.createElement("th");
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement("tbody");
                result.explain_plan.forEach(row => {
                    const tr = document.createElement("tr");
                    columnNames.forEach(col => {
                        const td = document.createElement("td");
                        td.textContent = row[col];
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);

                resultDiv.appendChild(table);
            } else {
                resultDiv.innerHTML += "<p>No explain plan returned.</p>";
            }

            resultDiv.innerHTML += `<h2>Query Results</h2>`;

            if (result.query_results.length > 0) {
                const table = document.createElement("table");
                table.classList.add("results-table");

                const thead = document.createElement("thead");
                const headerRow = document.createElement("tr");
                const columnNames = Object.keys(result.query_results[0]);
                columnNames.forEach(col => {
                    const th = document.createElement("th");
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement("tbody");
                result.query_results.forEach(row => {
                    const tr = document.createElement("tr");
                    columnNames.forEach(col => {
                        const td = document.createElement("td");
                        td.textContent = row[col];
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);

                resultDiv.appendChild(table);
            } else {
                resultDiv.innerHTML += "<p>No rows returned.</p>";
            }
        }
    </script>
</body>
</html>